# LLM Service — чат, RAG и субагенты

## Назначение
LLM Service обрабатывает пользовательские запросы, собирает контекст из внутренних источников, маршрутизирует задачи субагентам (маркетинг, право, финансы) и формирует ответы с цитированием релевантных материалов. Также сервис ведет историю диалогов и управляет шаблонами промптов.

## Зона ответственности
- Прием запросов от клиентского приложения (чат, команды субагентов, генерация договоров).
- Извлечение контекста организации: заметки, документы (через векторный поиск), шаблоны и внешние данные.
- RAG: подбор релевантных фрагментов из индекса и включение их в запрос модели.
- Субагенты: выбор профиля (маркетинг/право/финансы) и соответствующих инструкций/правил.
- Правовой сценарий: выявление требуемых полей шаблона, диалоговое заполнение, генерация итогового документа и сохранение результата в файловом хранилище.
- История диалогов: хранение сообщений, версия шаблонов промптов.
- Интеграции: использование данных внешних систем и веб‑поиска для актуализации ответа при необходимости.

## Основные сценарии
1. Обычный запрос в чат: получение сообщения, подбор контекста (заметки + документы), формирование ответа с цитатами.
2. Запрос к субагенту: маршрутизация в профильные правила и инструменты, возврат структурированного результата.
3. Генерация договора: определение шаблона, сбор полей через диалог/форму, построение финального документа, сохранение файла и уведомление Core Service о метаданных.
4. Обогащение контекста: при необходимости — обращение к внешним источникам и включение выдержек в ответ.

## Взаимодействия
- Клиентское приложение: прямые запросы на ответы модели и запуск сценариев субагентов/договоров.
- Vector Search: получение релевантных фрагментов для RAG.
- Core Service: чтение заметок/шаблонов (по необходимости) и регистрация метаданных сгенерированных документов.
- Хранилище файлов: сохранение итоговых файлов договоров для дальнейшей выдачи пользователю.
- Внешние источники: по запросу — данные из интеграций и веб‑поиска.

## Требования к доступу и контексту
- Запросы обрабатываются строго в контексте текущей организации пользователя.
- Ролевая модель учитывается при операциях, требующих модификации данных (например, управление шаблонами).
- В ответах указываются источники (фрагменты документов/заметок), если они использовались.

## Что не входит в объем (сейчас)
- Регистрация документов, пользователей и организаций (это ответственность Core Service).
- Извлечение текста и индексация документов (это ответственность Document Processing).
